---
output:
  word_document:
    toc: yes
  html_document: default
  pdf_document:
    toc: yes
---

Para este ejercicio vamos a utilizar datos reales provistos por el Ayuntamiento de Madrid, hablamos de los llamados datos abiertos u Open Data, en este caso, vamos a trabajar con las activaciones realizadas al SAMUR, es decir, cuando un ciudadano llama a la Protección Civil para una urgencia se realiza una activación al SAMUR, cuando eso sucede, se recopilan los siguientes datos:

Año
Mes
Hora de solicitud
Hora de intervención
Código de la emergencia
Distrito en el que se produce la emergencia
Hospital al que se traslada al ciudadano (si procede)


Concretamente, se utilizarán datos de activación al SAMUR con los años de 2017 a 2021, se dispondrá de los siguientes archivos.csv

activaciones_samur_2017.csv
activaciones_samur_2018.csv
activaciones_samur_2019.csv
activaciones_samur_2020.csv
activaciones_samur_2021.csv


La fuente original de los datos puede encontrarse en el siguiente enlace: https://datos.madrid.es/portal/site/egob/menuitem.c05c1f754a33a9fbe4b2e4b284f1a5a0/?vgnextoid=50d7d35982d6f510VgnVCM1000001d4a900aRCRD&vgnextchannel=374512b9ace9f310VgnVCM100000171f5a0aRCRD&vgnextfmt=default



Teniendo en cuenta la siguiente información se pide lo siguiente:

1.Lee todos los archivos como dataframes

Primero importamos todas las librerias que vamos a necesitar 

```{r}
library(tidyr)
```

```{r}
library(dplyr)
```


````{r}
library(ggplot2)
```

Ahora leeos los archivos csv (al descargarlos en W los edité para ver si estaban todos en el mismo código y condicones guardados, tuve que cambiar algunos para que se leyesen corectamente)

```{r}
samur1 <- read.csv("activaciones_samur_2017 .csv", header = TRUE, sep = ";",encoding = "Latin-1")
```

```{r}
head(samur1,10)
```

```{r}
samur2 <- read.csv("activaciones_samur_2018.csv", header = TRUE, sep = ";",encoding ="Latin-1")
```

```{r}
head(samur2,10)
```
```{r}

samur3 <- read.csv("activaciones_samur_2019.csv", header = TRUE, sep = ";",encoding ="Latin-1")

```



```{r}
head(samur3,10)
```

```{r}
samur4 <- read.csv("activaciones_samur_2020.csv", header = TRUE, sep = ";",encoding ="Latin-1")

```

```{r}
head(samur4,10)
```

```{r}
samur5 <- read.csv("activaciones_samur_2021.csv", header = TRUE, sep = ";",encoding ="Latin-1")

```


```{r}
head(samur5,10)
```


```{r}
samur6 <- read.csv("activaciones_samur_2022.csv", header = TRUE, sep = ";",encoding ="Latin-1")
```

```{r}
head(samur6,10)
```
  Una vez leídos concatenamos todos los archivo en uno solo
  
```{r}
myfiles= list.files(path = "C:/Users/Usuario/Desktop/Máster_IMF/Ejercicios_R", pattern= ".csv", full.names= TRUE)

```

```{r}
myfiles
```

```{r}
samurtotal <- data.frame()
for (i in 1:6) {
  tab <- get(paste0("samur",i))
  samurtotal <- rbind(samurtotal, tab)
}

```

```{r}
head(samurtotal,10)
```

```{r}
summary(samurtotal)
```

3.  Modifica los tipos de las columnas:

    Año: Entero (ya es entero) 
    Mes: Factor 
    Hora.Solicitud: Carater (ya es character) 
    Hora.Intervencion: Caracter (ya es character)
    Codigo: Caracter(ya es character)
    Distrito: Factor
    Hospital: Factor

```{r}
samurtotal$Mes <- as.factor(samurtotal$Mes)
samurtotal$Distrito <- as.factor(samurtotal$Distrito)
samurtotal$Hospital <- as.factor (samurtotal$Hospital)
```

```{r}
str(samurtotal)
```

4. Agrupa el dataframe por el código de la urgencia, ¿Cuáles son los tres códigos de urgencia más habituales? ¿Cuáles son los tres menos habituales?


```{r}
samurtotal %>% group_by(Código)
```
```{r}
samurtotal %>% count(Código, sort = TRUE) 
```

``

Los tres primeros son Casual: caída, etc.= 118.922
                      Patalogía cardiovascular = 114.552
                      Intoxicación etítica =56.897
                      
   
Los tres últimos son  Atención psicológica a intervinientes de Cuerpos de Seguridad = 2
                      Atención psicológica a intervinientes de Bomberos = 1
                      Pacientes en RCP prolongada =	1			
 
```{r}
head (samurtotal %>% count(Código, sort = TRUE),3)   
```



```{r}
tail (samurtotal %>% count(Código, sort = TRUE),3)
```


5.Observa los valores únicos de la variable Distrito, parece que hay un nivel (categoría) que es una cadena de texto vacía, asigna valor nulo a todas las cadenas de texto vacías para esta variable, ¿cuántos nulos aparecen? Elimina todos los valores nulos que hayan aparecido a raíz de esta transformación.


```{r}
unique(samurtotal$Distrito) 
```


```{r}
summary(samurtotal)
```

```{r}
samurtotal$Distrito[samurtotal$Distrito == ""] <- NA
```

```{r}
sum(is.na(samurtotal$Distrito))
```

Aparecen 5720

```{r}
samurtotal <- samurtotal %>% drop_na(Distrito)
```

Cuando los elimino, tenemos 696098 líneas, antes teníamos 701818 (696.098+5.720 = 701.818)

```{r}
summary(samurtotal)
```

6. Muestra los valores únicos de la variable Hospital, si hay algún factor que este vacío o que indique valor nulo, esto querrá decir que esa urgencia no requirió de hospitalización, para todos estos casos crea un nuevo factor o categoría que sea NO_HOSPITAL ¿cuántos casos hay en el dataframe que no requirieron de hospitalización?

```{r}
unique(samurtotal$Hospital)
```
```{r}
head(samurtotal,10)
```


```{r}
summary(samurtotal$Hospital)
```
Tenemos 479.103 casos de no hospitalización 

```{r}

 samurtotal$Hospital <- replace(samurtotal$Hospital,samurtotal$Hospital == "", "NO_HOSITAL")
```
```{r}
summary(samurtotal)
```
Me salen ya como NA, no me cambian a NO_HOSÌTAL, no sé por qué, ya que justo en la línea anterior si que estaba el espacio vacío y debería funcionar. 


7.Filtra el dataframe por todos los niveles distintos de NO_HOSPITAL, muestra los tres hospitales a los que más ciudadanos hayan sido trasladados


```{r}
head (samurtotal %>% count(Hospital, sort = TRUE),4) 
```
Los de mayor afluencia son el Gregorio Marañón, seguido del 12 de Octubre y tercero la Fundación J. Díaz (Concepción)
 

8. Agrupa el dataframe por la media de casos que se reciben al mes para cada año ¿En qué año se realizaron más activaciones del SAMUR?



```{r}
samurtotal %>% group_by(Mes,Año) %>% count(Código, sort = TRUE) %>% summarise (mean (n))

```
```{r}
samurtotal %>% group_by(Año) %>% count(Código) %>% summarise(mean(n))
```

El año con más avisos ha sido el 2019


9. Transforma la columna Hora.Solicitud en horas, minutos y segundos de solicitud, si aparece algún valor nulo elimínalo.


```{r}
samurtotal <- samurtotal %>% separate(Hora.Solicitud,c("horas", "minutos", "segundos"), sep= ":", remove = TRUE)
```
 Vemos que si que aparecen valores nulos, los identificamos y eliminamos. 
 
 
 
```{r}
head(samurtotal,10)
```
```{r}
samurtotal$horas<- as.factor(samurtotal$horas)
samurtotal$minutos <- as.factor(samurtotal$minutos)
samurtotal$segundos <- as.factor (samurtotal$segundos)

```


```{r}
summary(samurtotal)
```

```{r}
samurtotal$horas[samurtotal$horas == ""] <- NA

```



```{r}
samurtotal$minutos[samurtotal$minutos == ""] <- NA

```


```{r}
samurtotal$segundos[samurtotal$segundos== ""] <- NA

```

```{r}
summary(samurtotal)
```
```{r}
samurtotal <- samurtotal %>% drop_na(segundos)
```

```{r}
samurtotal <- samurtotal %>% drop_na(minutos)
```

```{r}
samurtotal <- samurtotal %>% drop_na(horas)
```


```{r}
summary(samurtotal)
```

Una forma opción  hubiese sido, antes de eliminar la columna Horas.solicitud, identificar en ella los valores vacíos y ponerlos como NA y eliminarlos. Y después hacer el separate.Vemos que se han elinado porque pasamos además de tener 696098 filas a 688783. Había  7315 nulos dentro de Horas.Solicitud

10.¿En qué hora se han producido más solicitudes al SAMUR?

El mayor número de avisos es a la una (13 horas)


```{r}
samurtotal %>% group_by(Mes,horas) %>% count (Código)

```

```{r}
samurtotal %>% group_by(horas) %>% count(Código) %>% summarise(mean(n))

```

El mayor número de incidencias se produce a la una de la tarde 



11. Muestra de forma gráfica el número de avisos por hora (Promedio mes).


```{r}
colnames(samurtotal)
```

```{r}

ggplot(samurtotal, aes(x=horas))+geom_histogram(bins = 24,
                                                colour="black", fill="darkgreen", 
                                                stat="count")+
                                                labs(title = "Nº de incidencias por hora")+
                                                ylab("Nº de incidencias")

```



12. Muestra gráficamente los avisos recibidos para cada año en función de cada mes ¿Se aprecian las consecuencias de la pandemia del COVID-19 en las activaciones realizadas a lo largo de los años? (Recuerda que el confinamiento en España comenzó en marzo de 2020)

```{r}
 summary(samurtotal)
   
```


```{r}
qplot(data = samurtotal, x = Mes,colour = Mes, stat = "count", facets = ~Año )

```


Vemos que antes de la pandemia más o menos el número de avisos era similar en el tiempo. A raiz del Covid esto cambió. Disminuyó, sobre todo en el 2020, año del confinamiento en casa. Del 2022 solo tenemos datos hasta marzo, aunque se puede ver que vuelven a aumentar los casos. 












